{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h2>üõí –°–±–æ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <p class="page-description">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–±–æ—Ä–∫–∏</p>
</div>

<div class="collection-container">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="upload-section">
        <div class="upload-card">
            <h3>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Å–±–æ—Ä–∫–∏</h3>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è Excel —Ñ–∞–π–ª—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤:</p>
            <ul>
                <li>SHK-Excel (—Å—Ç–æ–ª–±—Ü—ã: –ë–∞—Ä–∫–æ–¥, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, —à—Ç.)</li>
                <li>Products Export (—Å—Ç–æ–ª–±—Ü—ã: —à—Ç—Ä–∏—Ö–∫–æ–¥, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)</li>
                <li>–õ—é–±–æ–π Excel —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å—Ç–æ–ª–±—Ü–æ–≤</li>
            </ul>
            
            <div class="file-upload-area" id="fileUploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x"></i>
                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                <input type="file" id="collectionFile" accept=".xlsx" style="display: none;">
                <button class="btn btn-primary" id="selectFileBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            </div>
            
            <div id="fileName" class="file-name" style="display: none;"></div>
            
            <button class="btn btn-success" id="processFileBtn" style="display: none; margin-top: 1rem;">
                <i class="fas fa-cogs"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
    <div id="resultsSection" style="display: none;">
        <div class="results-header">
            <h3>üìã –ü–ª–∞–Ω —Å–±–æ—Ä–∫–∏</h3>
            <div class="results-stats">
                <div class="stat-badge">
                    <span class="stat-label">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π:</span>
                    <span class="stat-value" id="totalItems">0</span>
                </div>
                <div class="stat-badge">
                    <span class="stat-label">–ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å:</span>
                    <span class="stat-value" id="totalNeeded">0</span>
                </div>
                <div class="stat-badge">
                    <span class="stat-label">–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å:</span>
                    <span class="stat-value" id="totalTake">0</span>
                </div>
            </div>
        </div>

        <!-- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω -->
        <div class="optimized-plan">
            <h4>üó∫Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç —Å–±–æ—Ä–∫–∏</h4>
            <div id="optimizedPlan" class="plan-steps"></div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ -->
        <div class="detailed-plan">
            <h4>üìù –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h4>
            <div id="detailedPlan" class="items-list"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="confirmCollectionBtn">
                <i class="fas fa-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–±–æ—Ä–∫—É
            </button>
            <button class="btn btn-secondary" id="printPlanBtn">
                <i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å –ø–ª–∞–Ω–∞
            </button>
            <button class="btn btn-info" id="exportPlanBtn">
                <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
            </button>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="messageArea" style="margin-top: 1rem;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('collectionFile');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const fileName = document.getElementById('fileName');
    const processFileBtn = document.getElementById('processFileBtn');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const resultsSection = document.getElementById('resultsSection');
    const confirmCollectionBtn = document.getElementById('confirmCollectionBtn');
    const printPlanBtn = document.getElementById('printPlanBtn');
    const exportPlanBtn = document.getElementById('exportPlanBtn');
    const messageArea = document.getElementById('messageArea');

    let currentCollectionPlan = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    selectFileBtn.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            const file = this.files[0];
            fileName.textContent = `üìÑ ${file.name}`;
            fileName.style.display = 'block';
            processFileBtn.style.display = 'block';
            fileUploadArea.style.borderColor = '#28a745';
        }
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = '#007bff';
        this.style.backgroundColor = '#f8f9fa';
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = '#dee2e6';
        this.style.backgroundColor = '';
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = '#dee2e6';
        this.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            const file = e.dataTransfer.files[0];
            fileName.textContent = `üìÑ ${file.name}`;
            fileName.style.display = 'block';
            processFileBtn.style.display = 'block';
            fileUploadArea.style.borderColor = '#28a745';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞
    processFileBtn.addEventListener('click', processCollectionFile);

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏
    confirmCollectionBtn.addEventListener('click', confirmCollection);

    // –ü–µ—á–∞—Ç—å –ø–ª–∞–Ω–∞
    printPlanBtn.addEventListener('click', () => window.print());

    // –≠–∫—Å–ø–æ—Ä—Ç –ø–ª–∞–Ω–∞
    exportPlanBtn.addEventListener('click', exportCollectionPlan);

    function processCollectionFile() {
        if (!fileInput.files.length) {
            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        showMessage('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...', 'info');
        processFileBtn.disabled = true;
        processFileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞...';

        fetch('/api/process_collection', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentCollectionPlan = data;
                displayCollectionPlan(data);
                showMessage('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!', 'success');
            } else {
                showMessage('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        })
        .finally(() => {
            processFileBtn.disabled = false;
            processFileBtn.innerHTML = '<i class="fas fa-cogs"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª';
        });
    }

    function displayCollectionPlan(data) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalItems').textContent = data.total_items;
        document.getElementById('totalNeeded').textContent = data.total_needed;
        document.getElementById('totalTake').textContent = data.total_to_take;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω
        const optimizedPlan = document.getElementById('optimizedPlan');
        optimizedPlan.innerHTML = '';

        if (data.optimized_plan && data.optimized_plan.length > 0) {
            data.optimized_plan.forEach((location, index) => {
                const locationCard = document.createElement('div');
                locationCard.className = 'location-card';
                locationCard.innerHTML = `
                    <div class="location-header">
                        <h5>üìç ${location.zone} - üì¶ ${location.box}</h5>
                        <span class="badge">${location.items.length} —Ç–æ–≤–∞—Ä–æ–≤</span>
                    </div>
                    <div class="location-items">
                        ${location.items.map(item => `
                            <div class="location-item">
                                <strong>${item.product_name}</strong>
                                <div class="item-details">
                                    <span>–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${item.barcode}</span>
                                    <span>–í–∑—è—Ç—å: ${item.take} –∏–∑ ${item.needed} —à—Ç.</span>
                                    <span class="remaining">–û—Å—Ç–∞—Ç–æ–∫: ${item.remaining_after} —à—Ç.</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                optimizedPlan.appendChild(locationCard);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω
        const detailedPlan = document.getElementById('detailedPlan');
        detailedPlan.innerHTML = '';

        if (data.collection_plan && data.collection_plan.length > 0) {
            data.collection_plan.forEach((item, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <div class="item-info">
                        <h5>${index + 1}. ${item.product_name}</h5>
                        <p><strong>–®—Ç—Ä–∏—Ö-–∫–æ–¥:</strong> ${item.barcode}</p>
                        <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> ${item.article || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${item.take} –∏–∑ ${item.needed} —à—Ç.</p>
                        <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> ${item.zone} - ${item.box}</p>
                        <p><strong>–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏:</strong> ${item.remaining_after} —à—Ç.</p>
                    </div>
                `;
                detailedPlan.appendChild(itemCard);
            });
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        resultsSection.style.display = 'block';

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        confirmCollectionBtn.disabled = false;
        printPlanBtn.disabled = false;
        exportPlanBtn.disabled = false;
    }

    function confirmCollection() {
        if (!currentCollectionPlan || !currentCollectionPlan.collection_plan.length) {
            showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 'error');
            return;
        }

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–±–æ—Ä–∫—É? –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.')) {
            return;
        }

        confirmCollectionBtn.disabled = true;
        confirmCollectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';

        fetch('/api/confirm_collection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                collection_plan: currentCollectionPlan.collection_plan
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                confirmCollectionBtn.style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                printPlanBtn.style.marginRight = '0';
            } else {
                showMessage('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                confirmCollectionBtn.disabled = false;
                confirmCollectionBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–±–æ—Ä–∫—É';
            }
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            confirmCollectionBtn.disabled = false;
            confirmCollectionBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–±–æ—Ä–∫—É';
        });
    }

    function exportCollectionPlan() {
        if (!currentCollectionPlan) {
            showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
            return;
        }

        // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        const exportData = currentCollectionPlan.collection_plan.map(item => ({
            '–®—Ç—Ä–∏—Ö-–∫–æ–¥': item.barcode,
            '–ê—Ä—Ç–∏–∫—É–ª': item.article,
            '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞': item.product_name,
            '–¢—Ä–µ–±—É–µ—Ç—Å—è': item.needed,
            '–í–∑—è—Ç—å': item.take,
            '–ó–æ–Ω–∞': item.zone,
            '–ö–æ—Ä–æ–±–∫–∞': item.box,
            '–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏': item.remaining_after
        }));

        // –°–æ–∑–¥–∞–µ–º CSV —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const headers = ['–®—Ç—Ä–∏—Ö-–∫–æ–¥', '–ê—Ä—Ç–∏–∫—É–ª', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–¢—Ä–µ–±—É–µ—Ç—Å—è', '–í–∑—è—Ç—å', '–ó–æ–Ω–∞', '–ö–æ—Ä–æ–±–∫–∞', '–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏'];
        const csvContent = [
            headers.join(','),
            ...exportData.map(row => [
                row['–®—Ç—Ä–∏—Ö-–∫–æ–¥'],
                row['–ê—Ä—Ç–∏–∫—É–ª'],
                `"${row['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞']}"`,
                row['–¢—Ä–µ–±—É–µ—Ç—Å—è'],
                row['–í–∑—è—Ç—å'],
                `"${row['–ó–æ–Ω–∞']}"`,
                `"${row['–ö–æ—Ä–æ–±–∫–∞']}"`,
                row['–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏']
            ].join(','))
        ].join('\n');

        // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `collection_plan_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showMessage(message, type) {
        messageArea.innerHTML = `
            <div class="alert alert-${type}">
                ${message}
            </div>
        `;
        
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 5000);
    }
});
</script>

<style>
.collection-container {
    max-width: 1200px;
    margin: 0 auto;
}

.upload-card {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
    margin-bottom: 2rem;
}

.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 3rem 2rem;
    margin: 1.5rem 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.file-name {
    background: #e9ecef;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin: 1rem 0;
    font-weight: 500;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.results-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.stat-badge {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-label {
    display: block;
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #667eea;
}

.optimized-plan, .detailed-plan {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.location-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
}

.location-header {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
}

.location-header h5 {
    margin: 0;
    color: #333;
}

.location-items {
    padding: 1rem 1.5rem;
}

.location-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.location-item:last-child {
    border-bottom: none;
}

.location-item strong {
    color: #333;
    display: block;
    margin-bottom: 0.25rem;
}

.item-details {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: #666;
}

.item-details .remaining {
    color: #28a745;
    font-weight: 500;
}

.item-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid #e9ecef;
}

.item-card h5 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.item-card p {
    margin: 0.25rem 0;
    color: #666;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 2rem;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.badge {
    background: #667eea;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

@media (max-width: 768px) {
    .results-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .results-stats {
        width: 100%;
        justify-content: space-between;
    }
    
    .stat-badge {
        flex: 1;
        min-width: 100px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
}
</style>
{% endblock %}