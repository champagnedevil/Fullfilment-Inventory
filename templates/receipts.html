{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h2>Приёмки товаров</h2>
    <button class="btn btn-primary" id="importReceiptBtn">
        <i class="fas fa-file-import"></i> Импорт приёмки
    </button>
</div>

<!-- Статистика -->
<div class="stats-section">
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Всего приёмок</h3>
            <div class="stat-value" id="totalReceipts">0</div>
        </div>
        <div class="stat-card">
            <h3>Общее количество</h3>
            <div class="stat-value" id="totalQuantity">0</div>
        </div>
        <div class="stat-card">
            <h3>Всего товаров</h3>
            <div class="stat-value" id="totalProducts">0</div>
        </div>
    </div>
</div>

<!-- Список приёмок -->
<div class="receipts-section">
    <h3>Список приёмок</h3>
    <div class="receipts-list">
        {% for receipt in receipts %}
        <div class="receipt-card" data-receipt-id="{{ receipt.id }}">
            <div class="receipt-header">
                <div class="receipt-info">
                    <h4>{{ receipt.receipt_number }}</h4>
                    <p class="receipt-date">Дата: {{ receipt.receipt_date }}</p>
                    {% if receipt.description %}
                    <p class="receipt-description">{{ receipt.description }}</p>
                    {% endif %}
                </div>
                <div class="receipt-stats">
                    <div class="stat-badge">
                        <i class="fas fa-box"></i>
                        <span>{{ receipt.total_products }} товаров</span>
                    </div>
                    <div class="stat-badge">
                        <i class="fas fa-cubes"></i>
                        <span>{{ receipt.total_quantity }} шт.</span>
                    </div>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="btn btn-sm btn-info view-receipt-btn" data-receipt-id="{{ receipt.id }}">
                    <i class="fas fa-eye"></i> Просмотр
                </button>
                <button class="btn btn-sm btn-success export-receipt-btn" data-receipt-id="{{ receipt.id }}">
                    <i class="fas fa-file-excel"></i> Экспорт
                </button>
                <button class="btn btn-sm btn-danger delete-receipt-btn" data-receipt-id="{{ receipt.id }}">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            </div>
        </div>
        {% else %}
        <div class="no-receipts">
            <i class="fas fa-inbox fa-3x"></i>
            <h4>Нет приёмок</h4>
            <p>Импортируйте первую приёмку из Excel файла</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно импорта приёмки -->
<div id="importReceiptModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Импорт приёмки из Excel</h3>
            <span class="close" id="closeImportReceiptModal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="importReceiptForm">
                <div class="form-group">
                    <label for="receiptDate">Дата приёмки:</label>
                    <input type="date" id="receiptDate" required>
                </div>
                <div class="form-group">
                    <label for="receiptDescription">Описание (опционально):</label>
                    <textarea id="receiptDescription" rows="3" placeholder="Описание приёмки..."></textarea>
                </div>
                <div class="form-group">
                    <label>Файл Excel:</label>
                    <input type="file" id="receiptExcelFile" accept=".xlsx" style="display: none;">
                    <div class="file-input-group">
                        <button type="button" class="btn btn-info" id="selectReceiptFileBtn">
                            <i class="fas fa-file-import"></i> Выбрать файл
                        </button>
                        <span id="receiptFileName" class="file-name"></span>
                    </div>
                </div>
                <div id="importReceiptResult" style="margin-top: 1rem;"></div>
            </form>
            <div class="import-instructions">
                <h4>Инструкция по импорту:</h4>
                <p>Файл Excel должен содержать следующие колонки:</p>
                <ul>
                    <li><strong>Название товара</strong> (обязательно)</li>
                    <li><strong>Количество</strong> (обязательно)</li>
                    <li><strong>Штрих-код</strong> (опционально)</li>
                    <li><strong>Коробка</strong> (опционально)</li>
                    <li><strong>Зона</strong> (опционально)</li>
                </ul>
                <p class="note">Примечание: Все товары будут добавлены в одну приёмку</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelImportReceiptBtn">Отмена</button>
            <button class="btn btn-primary" id="confirmImportReceiptBtn" disabled>
                <i class="fas fa-upload"></i> Импортировать
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация даты
    document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
    
    // Загрузка статистики
    loadReceiptsStats();
    
    // Обработчики событий
    document.getElementById('importReceiptBtn').addEventListener('click', showImportReceiptModal);
    document.getElementById('selectReceiptFileBtn').addEventListener('click', selectReceiptFile);
    document.getElementById('confirmImportReceiptBtn').addEventListener('click', importReceipt);
    
    // Обработчики для кнопок приёмок
    document.querySelectorAll('.view-receipt-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const receiptId = this.getAttribute('data-receipt-id');
            window.location.href = `/receipt/${receiptId}`;
        });
    });
    
    document.querySelectorAll('.export-receipt-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const receiptId = this.getAttribute('data-receipt-id');
            window.location.href = `/api/receipts/${receiptId}/export_excel`;
        });
    });
    
    document.querySelectorAll('.delete-receipt-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const receiptId = this.getAttribute('data-receipt-id');
            deleteReceipt(receiptId);
        });
    });
    
    // Закрытие модальных окон
    document.getElementById('closeImportReceiptModal').addEventListener('click', closeImportReceiptModal);
    document.getElementById('cancelImportReceiptBtn').addEventListener('click', closeImportReceiptModal);
    
    // Обработчик выбора файла
    document.getElementById('receiptExcelFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('receiptFileName').textContent = file.name;
            document.getElementById('confirmImportReceiptBtn').disabled = false;
            document.getElementById('importReceiptResult').innerHTML = '';
        }
    });
});

function loadReceiptsStats() {
    fetch('/api/receipts/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalReceipts').textContent = data.stats.total_receipts;
                document.getElementById('totalQuantity').textContent = data.stats.total_quantity;
                document.getElementById('totalProducts').textContent = data.stats.total_products;
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function showImportReceiptModal() {
    document.getElementById('importReceiptModal').style.display = 'block';
}

function closeImportReceiptModal() {
    document.getElementById('importReceiptModal').style.display = 'none';
    document.getElementById('importReceiptForm').reset();
    document.getElementById('receiptFileName').textContent = '';
    document.getElementById('confirmImportReceiptBtn').disabled = true;
    document.getElementById('importReceiptResult').innerHTML = '';
}

function selectReceiptFile() {
    document.getElementById('receiptExcelFile').click();
}

function importReceipt() {
    const fileInput = document.getElementById('receiptExcelFile');
    const file = fileInput.files[0];
    const receiptDate = document.getElementById('receiptDate').value;
    const description = document.getElementById('receiptDescription').value;
    
    if (!file) {
        alert('Пожалуйста, выберите файл');
        return;
    }
    
    if (!receiptDate) {
        alert('Пожалуйста, укажите дату приёмки');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('receipt_date', receiptDate);
    formData.append('description', description);
    
    const resultDiv = document.getElementById('importReceiptResult');
    const importBtn = document.getElementById('confirmImportReceiptBtn');
    
    importBtn.disabled = true;
    importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Импорт...';
    
    fetch('/api/receipts/import_excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Успешно!</strong><br>
                    ${data.message}<br>
                    <small>Номер приёмки: ${data.receipt_number}</small>
                </div>
            `;
            
            // Обновляем страницу через 2 секунды
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-upload"></i> Импортировать';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="fas fa-upload"></i> Импортировать';
    });
}

function deleteReceipt(receiptId) {
    if (!confirm('Вы уверены, что хотите удалить эту приёмку? Все товары в ней также будут удалены.')) {
        return;
    }
    
    fetch(`/api/receipts/${receiptId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при удалении приёмки: ' + data.error);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error.message);
    });
}
</script>

<style>
.stats-section {
    margin-bottom: 2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card h3 {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.receipts-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.receipts-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.receipt-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.receipt-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.receipt-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.receipt-info h4 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.receipt-date {
    color: #666;
    margin: 0 0 0.5rem 0;
}

.receipt-description {
    color: #888;
    font-style: italic;
    margin: 0;
}

.receipt-stats {
    display: flex;
    gap: 1rem;
}

.stat-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.stat-badge i {
    color: #667eea;
}

.receipt-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.no-receipts {
    text-align: center;
    padding: 3rem;
    color: #666;
}

.no-receipts i {
    margin-bottom: 1rem;
    color: #ddd;
}

.file-input-group {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.file-name {
    color: #666;
}

.import-instructions {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9rem;
}

.import-instructions h4 {
    margin: 0 0 0.5rem 0;
    color: #495057;
}

.import-instructions ul {
    margin: 0.5rem 0 0.5rem 1.5rem;
}

.import-instructions .note {
    font-style: italic;
    color: #6c757d;
    margin: 0.5rem 0 0 0;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
</style>
{% endblock %}